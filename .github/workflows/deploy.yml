name: Deploy AI Digital Twin

on:
  push:
    branches:
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - test
          - prod

env:
  AWS_REGION: us-east-1
  PROJECT_NAME: twin

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'dev' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: Install backend dependencies
        working-directory: backend
        run: npm ci

      - name: Build backend
        working-directory: backend
        run: |
          npm run build
          mkdir -p dist/data
          cp -r data/* dist/data/
          cd dist && zip -r ../lambda-deployment.zip .

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Set environment
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "stack_name=${{ env.PROJECT_NAME }}-$ENV" >> $GITHUB_OUTPUT

      - name: Deploy CloudFormation stack
        run: |
          STACK_NAME="${{ steps.env.outputs.stack_name }}"

          # Check if stack exists
          if aws cloudformation describe-stacks --stack-name "$STACK_NAME" 2>&1 | grep -q "does not exist"; then
            echo "Creating new stack..."
            aws cloudformation create-stack \
              --stack-name "$STACK_NAME" \
              --template-body file://cloudformation/main.yaml \
              --parameters \
                ParameterKey=OpenAIApiKey,ParameterValue=${{ secrets.OPENAI_API_KEY }} \
              --capabilities CAPABILITY_NAMED_IAM \
              --tags Key=Environment,Value=${{ steps.env.outputs.environment }} Key=Project,Value=${{ env.PROJECT_NAME }}

            aws cloudformation wait stack-create-complete --stack-name "$STACK_NAME"
          else
            echo "Updating existing stack..."
            aws cloudformation update-stack \
              --stack-name "$STACK_NAME" \
              --template-body file://cloudformation/main.yaml \
              --parameters \
                ParameterKey=OpenAIApiKey,ParameterValue=${{ secrets.OPENAI_API_KEY }} \   
              --capabilities CAPABILITY_NAMED_IAM 2>&1 || true

            aws cloudformation wait stack-update-complete --stack-name "$STACK_NAME" 2>&1 || true
          fi

      - name: Get stack outputs
        id: outputs
        run: |
          STACK_NAME="${{ steps.env.outputs.stack_name }}"
          OUTPUTS=$(aws cloudformation describe-stacks --stack-name "$STACK_NAME" --query 'Stacks[0].Outputs')

          echo "frontend_bucket=$(echo $OUTPUTS | jq -r '.[] | select(.OutputKey=="FrontendBucketName") | .OutputValue')" >> $GITHUB_OUTPUT
          echo "lambda_function=$(echo $OUTPUTS | jq -r '.[] | select(.OutputKey=="LambdaFunctionName") | .OutputValue')" >> $GITHUB_OUTPUT
          echo "cloudfront_url=$(echo $OUTPUTS | jq -r '.[] | select(.OutputKey=="CloudFrontUrl") | .OutputValue')" >> $GITHUB_OUTPUT
          echo "cloudfront_id=$(echo $OUTPUTS | jq -r '.[] | select(.OutputKey=="CloudFrontDistributionId") | .OutputValue')" >> $GITHUB_OUTPUT
          echo "api_url=$(echo $OUTPUTS | jq -r '.[] | select(.OutputKey=="ApiGatewayUrl") | .OutputValue')" >> $GITHUB_OUTPUT

      - name: Upload Lambda code
        working-directory: backend
        run: |
          aws lambda update-function-code \
            --function-name "${{ steps.outputs.outputs.lambda_function }}" \
            --zip-file fileb://lambda-deployment.zip

      - name: Upload frontend to S3
        working-directory: frontend
        run: |
          aws s3 sync out/ s3://${{ steps.outputs.outputs.frontend_bucket }}/ --delete

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ steps.outputs.outputs.cloudfront_id }}" \
            --paths "/*"

      - name: Deployment summary
        run: |
          echo "## Deployment Complete! :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ steps.env.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**CloudFront URL:** ${{ steps.outputs.outputs.cloudfront_url }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${{ steps.outputs.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Health Check" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          curl -s "${{ steps.outputs.outputs.api_url }}/health" | jq . >> $GITHUB_STEP_SUMMARY || echo "Health check pending..." >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
